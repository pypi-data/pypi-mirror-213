{"version":3,"sources":["styles.tsx","types.tsx","interaction_handling.tsx","mapbox.tsx","utilities.tsx","index.tsx"],"names":["so_stylish","Raster","filename","height","width","src_crs","src_transform","crs","bounds","base_dir","transform","raster_type","_classCallCheck","_createClass","key","value","this","get","replace","CartographerState","location","zoom","viewport_bounds","rasters","feature_collection","pointclouds","unique_labels","selected_label","type","features","map","cUR","unproject","toArray","coordinates","center","getZoom","flat","raster","__dict__","instance","data","cartographerData","args","isValidCartographerData","Error","JSON","stringify","getInstance","rasterData","console","log","every","Object","prototype","hasOwnProperty","call","SliderOverlayControl","sourceIds","container","document","createElement","className","createSliderOverlays","_this","sliders","mapOverlay","style","forEach","sourceId","mapOverlayInner","display","label","length","textContent","shortenedsourceId","substring","title","input","sliderId","id","min","max","step","startsWith","appendChild","addEventListener","e","window","getLayer","target","setPaintProperty","parseInt","push","_this$container$paren","parentNode","removeChild","addMapillaryFeature","_x","_x2","_x3","_addMapillaryFeature","apply","arguments","_asyncToGenerator","_regeneratorRuntime","mark","_callee","filteredFeatures","featureCollectionSubset","source","img","wrap","_context","prev","next","filter","feature","properties","description","getSource","setData","addSource","Image","onload","addImage","addLayer","layout","src","stop","addGeoJSONLayers","featureCollection","_step","addedSourceIds","Set","_iterator","_createForOfIteratorHelper","_loop","_feature$properties","add","_featureCollectionSub","fillColor","color","paint","s","n","done","err","f","buildColorPalette","colorList","palette","index","require","config","mapboxgl","accessToken","process","MAPBOX_API_KEY","MAPILLARY_API_KEY","styleLoaded","updateBackendWithState","Streamlit","setComponentValue","state","addRasterToMap","png_filename","url","sources","updateMapWithRasters","removeLayer","removeSource","delete","removeRasters","i","has","rasterSourceIds","sliderOverlayControl","addControl","updateViewportFromMap","initializeMap","Map","LngLat","draw","MapboxDraw","displayControlsDefault","controls","styles","userProperties","map_initialized","draw_ctrl_visible","on","tileSize","maxzoom","setTerrain","exaggeration","_objectSpread","vectorSourceIds","concat","_toConsumableArray","Array","from","getAll","ScaleControl","maxWidth","unit","events","RENDER_EVENT","event","detail","initializeFromEvent","removeControl","new_draw","polygon","trash","combine_features","uncombine_features","buildDrawPlugin","changed","setComponentReady","setFrameHeight"],"mappings":"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","file":"static/js/main.380fae73.chunk.js","sourcesContent":["export const so_stylish = [\n    {\n      'id': 'fill-it',\n      'type': 'fill',\n      'filter': ['all', ['==', '$type', 'Polygon'], ['!=', 'mode', 'static']],\n      'paint': {\n        'fill-color': ['get', 'user_color'],\n        'fill-outline-color': '#000000',\n        'fill-opacity': 0.3,\n      }\n    },\n\n  // {\n  //   'id': 'gl-draw-polygon-fill-inactive',\n  //   'type': 'fill',\n  //   'filter': ['all',\n  //     ['==', 'active', 'false'],\n  //     ['==', '$type', 'Polygon'],\n  //     ['!=', 'mode', 'static']\n  //   ],\n  //   'paint': {\n  //     'fill-color': '#3bb2d0',\n  //     'fill-outline-color': '#3bb2d0',\n  //     'fill-opacity': 0.1\n  //   }\n  // },\n  {\n    'id': 'gl-draw-polygon-fill-active',\n    'type': 'fill',\n    'filter': ['all', ['==', 'active', 'true'], ['==', '$type', 'Polygon']],\n    'paint': {\n      'fill-color': '#fbb03b',\n      'fill-outline-color': '#fbb03b',\n      'fill-opacity': 0.1\n    }\n  },\n  {\n    'id': 'gl-draw-polygon-midpoint',\n    'type': 'circle',\n    'filter': ['all',\n      ['==', '$type', 'Point'],\n      ['==', 'meta', 'midpoint']],\n    'paint': {\n      'circle-radius': 3,\n      'circle-color': '#fbb03b'\n    }\n  },\n  {\n    'id': 'gl-draw-polygon-stroke-inactive',\n    'type': 'line',\n    'filter': ['all',\n      ['==', 'active', 'false'],\n      ['==', '$type', 'Polygon'],\n      ['!=', 'mode', 'static']\n    ],\n    'layout': {\n      'line-cap': 'round',\n      'line-join': 'round'\n    },\n    'paint': {\n      'line-color': '#000000',\n      'line-width': 1\n    }\n  },\n  {\n    'id': 'gl-draw-polygon-stroke-active',\n    'type': 'line',\n    'filter': ['all', ['==', 'active', 'true'], ['==', '$type', 'Polygon']],\n    'layout': {\n      'line-cap': 'round',\n      'line-join': 'round'\n    },\n    'paint': {\n      'line-color': '#fbb03b',\n      'line-dasharray': [0.2, 2],\n      'line-width': 2\n    }\n  },\n  {\n    'id': 'gl-draw-line-inactive',\n    'type': 'line',\n    'filter': ['all',\n      ['==', 'active', 'false'],\n      ['==', '$type', 'LineString'],\n      ['!=', 'mode', 'static']\n    ],\n    'layout': {\n      'line-cap': 'round',\n      'line-join': 'round'\n    },\n    'paint': {\n      'line-color': '#3bb2d0',\n      'line-width': 2\n    }\n  },\n  {\n    'id': 'gl-draw-line-active',\n    'type': 'line',\n    'filter': ['all',\n      ['==', '$type', 'LineString'],\n      ['==', 'active', 'true']\n    ],\n    'layout': {\n      'line-cap': 'round',\n      'line-join': 'round'\n    },\n    'paint': {\n      'line-color': '#fbb03b',\n      'line-dasharray': [0.2, 2],\n      'line-width': 2\n    }\n  },\n  {\n    'id': 'gl-draw-polygon-and-line-vertex-stroke-inactive',\n    'type': 'circle',\n    'filter': ['all',\n      ['==', 'meta', 'vertex'],\n      ['==', '$type', 'Point'],\n      ['!=', 'mode', 'static']\n    ],\n    'paint': {\n      'circle-radius': 5,\n      'circle-color': '#fff'\n    }\n  },\n  {\n    'id': 'gl-draw-polygon-and-line-vertex-inactive',\n    'type': 'circle',\n    'filter': ['all',\n      ['==', 'meta', 'vertex'],\n      ['==', '$type', 'Point'],\n      ['!=', 'mode', 'static']\n    ],\n    'paint': {\n      'circle-radius': 3,\n      'circle-color': '#fbb03b'\n    }\n  },\n  {\n    'id': 'gl-draw-point-point-stroke-inactive',\n    'type': 'circle',\n    'filter': ['all',\n      ['==', 'active', 'false'],\n      ['==', '$type', 'Point'],\n      ['==', 'meta', 'feature'],\n      ['!=', 'mode', 'static']\n    ],\n    'paint': {\n      'circle-radius': 5,\n      'circle-opacity': 1,\n      'circle-color': '#fff'\n    }\n  },\n  {\n    'id': 'gl-draw-point-inactive',\n    'type': 'circle',\n    'filter': ['all',\n      ['==', 'active', 'false'],\n      ['==', '$type', 'Point'],\n      ['==', 'meta', 'feature'],\n      ['!=', 'mode', 'static']\n    ],\n    'paint': {\n      'circle-radius': 3,\n      'circle-color': ['get', 'user_color'],\n    }\n  },\n  {\n    'id': 'gl-draw-point-stroke-active',\n    'type': 'circle',\n    'filter': ['all',\n      ['==', '$type', 'Point'],\n      ['==', 'active', 'true'],\n      ['!=', 'meta', 'midpoint']\n    ],\n    'paint': {\n      'circle-radius': 7,\n      'circle-color': '#fff'\n    }\n  },\n  {\n    'id': 'gl-draw-point-active',\n    'type': 'circle',\n    'filter': ['all',\n      ['==', '$type', 'Point'],\n      ['!=', 'meta', 'midpoint'],\n      ['==', 'active', 'true']],\n    'paint': {\n      'circle-radius': 5,\n      'circle-color': ['get', 'user_color'],\n    }\n  },\n  {\n    'id': 'gl-draw-polygon-fill-static',\n    'type': 'fill',\n    'filter': ['all', ['==', 'mode', 'static'], ['==', '$type', 'Polygon']],\n    'paint': {\n      'fill-color': '#404040',\n      'fill-outline-color': '#404040',\n      'fill-opacity': 0.1\n    }\n  },\n  {\n    'id': 'gl-draw-polygon-stroke-static',\n    'type': 'line',\n    'filter': ['all', ['==', 'mode', 'static'], ['==', '$type', 'Polygon']],\n    'layout': {\n      'line-cap': 'round',\n      'line-join': 'round'\n    },\n    'paint': {\n      'line-color': '#404040',\n      'line-width': 2\n    }\n  },\n  {\n    'id': 'gl-draw-line-static',\n    'type': 'line',\n    'filter': ['all', ['==', 'mode', 'static'], ['==', '$type', 'LineString']],\n    'layout': {\n      'line-cap': 'round',\n      'line-join': 'round'\n    },\n    'paint': {\n      'line-color': '#404040',\n      'line-width': 2\n    }\n  },\n  {\n    'id': 'gl-draw-point-static',\n    'type': 'circle',\n    'filter': ['all', ['==', 'mode', 'static'], ['==', '$type', 'Point']],\n    'paint': {\n      'circle-radius': 5,\n      'circle-color': '#404040'\n    }\n  }\n];","import mapboxgl from \"mapbox-gl\"\nimport MapboxDraw from \"@mapbox/mapbox-gl-draw\"\nimport { RenderData } from \"streamlit-component-lib\"\n\nexport class Raster {\n  constructor(\n    public filename: string,\n    public height: number,\n    public width: number,\n    public src_crs: number,\n    public src_transform: any,\n    public crs: number,\n    public bounds: [number, number, number, number],\n    public base_dir: string,\n    public transform: any,\n    public raster_type: string\n  ) {}\n\n  public __dict__(): any {\n    return {\n      filename: this.filename,\n      height: this.height,\n      width: this.width,\n      crs: this.crs,\n      src_crs: this.src_crs,\n      src_transform: this.src_transform,\n      bounds: this.bounds,\n      base_dir: this.base_dir,\n      transform: this.transform,\n      raster_type: this.raster_type,\n    }\n  }\n\n  get png_filename(): string {\n    return this.filename.replace(/\\.[^/.]+$/, \".png\")\n  }\n}\nexport class CartographerState {\n  private static instance: CartographerState\n\n  public location: GeoJSON.Position\n  public zoom: number\n  public viewport_bounds: number[]\n  public rasters: Raster[]\n  public feature_collection: GeoJSON.FeatureCollection\n  public pointclouds: any[]\n  public unique_labels: string[]\n  public selected_label: string\n\n  private constructor() {\n    // Initialize the properties with default values\n    this.location = [0, 0]\n    this.zoom = 0\n    this.viewport_bounds = [0, 0, 0, 0]\n    this.rasters = []\n    this.feature_collection = { type: \"FeatureCollection\", features: [] }\n    this.pointclouds = []\n    this.unique_labels = []\n    this.selected_label = \"\"\n  }\n\n  public static getInstance(): CartographerState {\n    if (!CartographerState.instance) {\n      CartographerState.instance = new CartographerState()\n    }\n    return CartographerState.instance\n  }\n\n  public static initializeFromEvent(data: RenderData): void {\n    const cartographerData = data.args[\"cartographer_state\"]\n    // Here we perform input validation before assigning the data to the singleton instance\n    if (cartographerData && this.isValidCartographerData(cartographerData)) {\n      const instance = this.getInstance()\n      instance.location = cartographerData.location\n      instance.zoom = cartographerData.zoom\n      instance.viewport_bounds = cartographerData.viewport_bounds\n      instance.rasters = cartographerData.rasters.map(\n        (rasterData: any) =>\n          new Raster(\n            rasterData.filename,\n            rasterData.height,\n            rasterData.width,\n            rasterData.crs,\n            rasterData.src_crs,\n            rasterData.src_transform,\n            rasterData.bounds,\n            rasterData.base_dir,\n            rasterData.transform,\n            rasterData.raster_type\n          )\n      )\n      console.log(cartographerData.feature_collection)\n      instance.feature_collection = cartographerData.feature_collection\n      instance.pointclouds = cartographerData.pointclouds\n      instance.unique_labels = cartographerData.unique_labels\n      instance.selected_label = cartographerData.selected_label\n    } else {\n      throw new Error(\n        \"USER CODE ERROR: Throwing because we received invalid data from the server\" +\n          JSON.stringify(cartographerData)\n      )\n    }\n  }\n\n  private static isValidCartographerData(data: any): boolean {\n    const requiredKeys = [\n      \"location\",\n      \"zoom\",\n      \"viewport_bounds\",\n      \"rasters\",\n      \"feature_collection\",\n      \"pointclouds\",\n      \"unique_labels\",\n      \"selected_label\",\n    ]\n\n    return (\n      data &&\n      requiredKeys.every((key) =>\n        Object.prototype.hasOwnProperty.call(data, key)\n      )\n    )\n  }\n  public updateViewportFromMap(map: any): void {\n    let width = 1024\n    let height = 660\n    var cUR = map.unproject([width, 0]).toArray()\n    var cLL = map.unproject([0, height]).toArray()\n    var coordinates = [cLL, cUR]\n    var center = map.unproject([width / 2, height / 2]).toArray()\n\n    this.location = center as GeoJSON.Position\n    this.zoom = map.getZoom()\n    this.viewport_bounds = coordinates.flat()\n  }\n  public __dict__(): {} {\n    // translate the raster objects to dictionaries\n    return {\n      location: this.location,\n      zoom: this.zoom,\n      viewport_bounds: this.viewport_bounds,\n      rasters: this.rasters.map((raster) => raster.__dict__()),\n      feature_collection: this.feature_collection,\n      pointclouds: this.pointclouds,\n      unique_labels: this.unique_labels,\n      selected_label: this.selected_label,\n    }\n  }\n}\ndeclare global {\n  interface Window {\n    state: CartographerState\n    map_initialized: boolean\n    MAPILLARY_API_KEY: string\n    map: mapboxgl.Map\n    draw: MapboxDraw\n    sources: Set<string>\n    palette: { [str: string]: string }\n    draw_ctrl_visible: boolean\n  }\n}\n","import mapboxgl from \"mapbox-gl\"\n\nclass SliderOverlayControl implements mapboxgl.IControl {\n  private sourceIds: string[]\n  private map: mapboxgl.Map\n  private container: HTMLDivElement\n\n  constructor(sourceIds: string[], map: mapboxgl.Map) {\n    this.sourceIds = sourceIds\n    this.map = map\n    this.container = document.createElement(\"div\")\n    this.container.className = \"mapboxgl-ctrl mapboxgl-ctrl-top-left\"\n\n    this.createSliderOverlays()\n  }\n  private createSliderOverlays() {\n    const sliders: Record<string, HTMLInputElement> = {}\n    const mapOverlay = document.createElement(\"div\")\n    mapOverlay.className = \"map-overlay top\"\n    mapOverlay.style.width = \"200px\"\n    this.sourceIds.forEach((sourceId: string) => {\n      const mapOverlayInner = document.createElement(\"div\")\n      mapOverlayInner.className = \"map-overlay-inner\"\n      mapOverlayInner.style.display = \"block\"\n\n      const label = document.createElement(\"label\")\n      // only add the dots if its too long\n      if (sourceId.length <= 20) {\n        label.textContent = sourceId\n      } else {\n        const shortenedsourceId = sourceId.substring(0, 20) + \"...\"\n        label.textContent = shortenedsourceId\n      }\n      label.title = sourceId\n\n      label.style.display = \"flex\" // Adjust the display style as needed\n\n      const input = document.createElement(\"input\")\n      const sliderId = \"slider-\" + sourceId\n      input.id = sliderId\n      input.type = \"range\"\n      input.min = \"0\"\n      input.max = \"100\"\n      input.step = \"1\"\n      console.log(sourceId)\n      if (sourceId.startsWith(\"maxar\")) {\n        input.value = \"100\"\n      } else {\n        input.value = \"40\"\n      }\n      input.style.width = \"100%\" // Add this line to make the slider element expand to its parent's width\n\n      mapOverlayInner.appendChild(label)\n      mapOverlayInner.appendChild(input)\n\n      mapOverlay.appendChild(mapOverlayInner)\n\n      sliders[sliderId] = input\n\n      input.addEventListener(\"input\", (e) => {\n        console.log(window.map.getLayer(sourceId).type)\n\n        const value = (e.target as HTMLInputElement).value\n        if (window.map.getLayer(sourceId).type === \"raster\") {\n          this.map.setPaintProperty(\n            sourceId,\n            \"raster-opacity\",\n            parseInt(value, 10) / 100\n          )\n        } else if (window.map.getLayer(sourceId).type === \"fill\") {\n          this.map.setPaintProperty(\n            sourceId,\n            \"fill-opacity\",\n            parseInt(value, 10) / 100\n          )\n        }\n      })\n    })\n    this.container.appendChild(mapOverlay)\n  }\n\n  addSourceId(sourceId: string) {\n    this.sourceIds.push(sourceId)\n    this.createSliderOverlays()\n  }\n\n  onAdd() {\n    return this.container\n  }\n\n  onRemove() {\n    this.container.parentNode?.removeChild(this.container)\n  }\n}\n\nexport { SliderOverlayControl }\n","import mapboxgl from \"mapbox-gl\"\nimport MapboxDraw from \"@mapbox/mapbox-gl-draw\"\nimport { so_stylish } from \"./styles\"\nimport { GeoJSON } from \"geojson\"\n\nexport async function addMapillaryFeature(\n  map: mapboxgl.Map,\n  feature_collection: GeoJSON.FeatureCollection,\n  className: string\n) {\n  // Query the features from the source\n  const features = feature_collection.features\n  const filteredFeatures = features.filter(\n    (feature) =>\n      feature.properties &&\n      feature.properties.type === \"mapillary_feature\" &&\n      feature.properties.description === className\n  )\n\n  let featureCollectionSubset = {\n    type: \"FeatureCollection\",\n    features: filteredFeatures,\n  } as GeoJSON.FeatureCollection\n  let source = map.getSource(className)\n\n  if (source) {\n    // @ts-ignore\n    source.setData(featureCollectionSubset)\n  } else {\n    console.log(\"adding source for \" + className)\n    console.log(featureCollectionSubset.features.length)\n    map.addSource(className, {\n      type: \"geojson\",\n      data: featureCollectionSubset,\n    })\n\n    const img = new Image()\n    img.onload = function () {\n      map.addImage(className, img)\n      map.addLayer({\n        id: className + \"-layer\",\n        type: \"symbol\",\n        source: className,\n        layout: {\n          \"icon-image\": className,\n          \"icon-size\": 0.15,\n          \"icon-allow-overlap\": true,\n        },\n      })\n    }\n    img.src = \"http://localhost:3001/mapillary/\" + className + \".svg\"\n  }\n}\n\nexport function addGeoJSONLayers(\n  map: mapboxgl.Map,\n  sourceIds: string[],\n  featureCollection: GeoJSON.FeatureCollection\n) {\n  var addedSourceIds = new Set<string>()\n  for (const sourceId of sourceIds) {\n    let source = map.getSource(sourceId)\n    let featureCollectionSubset = {\n      type: \"FeatureCollection\",\n      features: featureCollection.features.filter((feature) => {\n        return feature.properties?.description === sourceId\n      }),\n    } as GeoJSON.FeatureCollection\n    if (featureCollectionSubset.features.length == 0) {\n      continue\n    }\n    if (source) {\n      // @ts-ignore\n      source.setData(featureCollectionSubset)\n      addedSourceIds.add(sourceId)\n    } else {\n      map.addSource(sourceId, {\n        type: \"geojson\",\n        data: featureCollectionSubset,\n      })\n      let fillColor = featureCollectionSubset.features[0].properties?.color\n      map.addLayer({\n        id: sourceId,\n        type: \"fill\",\n        source: sourceId,\n        paint: {\n          \"fill-color\": fillColor,\n          \"fill-opacity\": 0.4,\n        },\n        filter: [\"==\", \"$type\", \"Polygon\"],\n      })\n    }\n    addedSourceIds.add(sourceId)\n  }\n  return addedSourceIds\n}\n\nexport function buildDrawPlugin() {\n  window.map.removeControl(window.draw)\n  const new_draw = new MapboxDraw({\n    displayControlsDefault: true,\n    controls: {\n      polygon: true,\n      trash: true,\n      combine_features: false,\n      uncombine_features: false,\n    },\n    styles: so_stylish,\n    userProperties: true,\n  })\n\n  window.map.addControl(new_draw)\n  return new_draw\n}\n","import { GeoJSON } from \"geojson\"\nimport mapboxgl from \"mapbox-gl\"\n\nfunction cornerBounds(bounds: [number, number, number, number]): number[][] {\n  return [\n    // [ (lu), (ru), (rd), (ld) ]\n    [bounds[0], bounds[3]],\n    [bounds[2], bounds[3]],\n    [bounds[2], bounds[1]],\n    [bounds[0], bounds[1]],\n  ]\n}\n\nfunction assignColorsToFeatures(\n  features: GeoJSON.Feature<GeoJSON.Geometry, any>[]\n): void {\n  features.forEach((feature) => {\n    const color = window.palette[feature.properties.description]\n    feature.properties = {\n      ...feature.properties,\n      color,\n    }\n  })\n}\n\nfunction buildColorPalette(unique_labels: string[]): any {\n  const colorList = [\n    \"#FF6F40\", // Coral\n    \"#1CA953\", // Forest Green\n    \"#0077B6\", // Cerulean Blue\n    \"#FFC300\", // Vivid Yellow\n    \"#B7410E\", // Rust\n    \"#2F4F4F\", // Slate Gray\n    \"#800080\", // Purple\n    \"#FF55A3\", // Fuchsia Pink\n  ]\n\n  const palette: { [string: string]: string } = {}\n  unique_labels.forEach((label, index) => {\n    palette[label] = colorList[index % colorList.length]\n  })\n  return palette\n}\nfunction configureServices() {\n  require(\"dotenv\").config()\n  mapboxgl.accessToken =\n    process.env.MAPBOX_API_KEY ||\n    \"pk.eyJ1IjoibXdlaXNzMTAiLCJhIjoiY2xoajl0OGMxMGZwYTNnczZ2OTh1eXRreCJ9.ywUieENhWVdQP3hOP4Hycg\"\n  window.MAPILLARY_API_KEY =\n    process.env.MAPILLARY_API_KEY ||\n    \"MLY|6088287754621284|776bc701a5aebf616cb82964e04a6398\"\n}\n\nexport {\n  cornerBounds,\n  assignColorsToFeatures,\n  buildColorPalette,\n  configureServices,\n}\n","import { RenderData, Streamlit } from \"streamlit-component-lib\"\nimport mapboxgl from \"mapbox-gl\"\nimport \"mapbox-gl/dist/mapbox-gl.css\"\nimport MapboxDraw from \"@mapbox/mapbox-gl-draw\"\nimport { so_stylish } from \"./styles\"\nimport { Raster, CartographerState } from \"./types\"\nimport { SliderOverlayControl } from \"./interaction_handling\"\nimport {\n  addGeoJSONLayers,\n  addMapillaryFeature,\n  buildDrawPlugin,\n} from \"./mapbox\"\nimport {\n  cornerBounds,\n  assignColorsToFeatures,\n  buildColorPalette,\n  configureServices,\n} from \"./utilities\"\n\nconfigureServices()\nlet styleLoaded = false\n\nfunction updateBackendWithState(): void {\n  Streamlit.setComponentValue(window.state.__dict__())\n}\n\nfunction addRasterToMap(map: any, raster: Raster) {\n  map.addSource(raster.png_filename, {\n    type: \"image\",\n    url: \"http://localhost:8501/app/static/\" + raster.png_filename,\n    coordinates: cornerBounds(raster.bounds),\n  })\n  if (raster.raster_type === \"predicted_overlay\") {\n    map.addLayer({\n      id: raster.png_filename,\n      type: \"raster\",\n      source: raster.png_filename,\n      paint: {\n        \"raster-fade-duration\": 0,\n        \"raster-opacity\": 0.4,\n      },\n    })\n  } else if (raster.raster_type === \"base_satellite_image\") {\n    map.addLayer({\n      id: raster.png_filename,\n      type: \"raster\",\n      source: raster.png_filename,\n      paint: {\n        \"raster-fade-duration\": 0,\n        \"raster-opacity\": 1.0,\n      },\n    })\n  }\n\n  window.sources.add(raster.png_filename)\n}\n\nfunction removeRasters(map: mapboxgl.Map) {\n  window.sources.forEach((source) => {\n    if (\n      source !== \"mapbox-dem\" &&\n      source !== \"mapillary\" &&\n      source.startsWith(\"prediction\")\n    ) {\n      map.removeLayer(source)\n      map.removeSource(source)\n      window.sources.delete(source)\n    }\n  })\n}\n\nfunction updateMapWithRasters(map: mapboxgl.Map, rasters: Raster[]) {\n  removeRasters(map)\n  for (let i = 0; i < rasters.length; i++) {\n    let raster = rasters[i]\n    // if its the predicted overlay\n    if (raster.raster_type === \"predicted_overlay\") {\n      if (rasters.length === 3 && i === 2) {\n        addRasterToMap(map, raster)\n      } else if (rasters.length === 2 && i === 1) {\n        addRasterToMap(map, raster)\n      }\n    }\n    // if its the ground truth overlay\n    else if (\n      raster.raster_type === \"base_satellite_image\" &&\n      !window.sources.has(raster.png_filename)\n    ) {\n      addRasterToMap(map, raster)\n    }\n  }\n  var rasterSourceIds = rasters.map((raster) => raster.png_filename)\n  const sliderOverlayControl = new SliderOverlayControl(rasterSourceIds, map)\n  map.addControl(sliderOverlayControl, \"top-left\")\n\n  window.state.updateViewportFromMap(map)\n  // updateBackendWithState()\n}\n\nfunction initializeMap(state: CartographerState): mapboxgl.Map {\n  let map = new mapboxgl.Map({\n    container: \"map\",\n    style: \"mapbox://styles/mapbox/satellite-streets-v12\",\n    center: new mapboxgl.LngLat(state.location[0], state.location[1]),\n    zoom: 17,\n  })\n  window.map = map\n\n  window.draw = new MapboxDraw({\n    displayControlsDefault: false,\n    controls: {},\n    styles: so_stylish,\n    userProperties: true,\n  })\n  window.map.addControl(window.draw)\n  window.map_initialized = false\n  window.state.updateViewportFromMap(map)\n  window.palette = {}\n  window.sources = new Set<string>()\n  window.draw_ctrl_visible = false\n\n  map.on(\"load\", () => {\n    styleLoaded = true\n    map.addSource(\"mapbox-dem\", {\n      type: \"raster-dem\",\n      url: \"mapbox://mapbox.mapbox-terrain-dem-v1\",\n      tileSize: 512,\n      maxzoom: 14,\n    })\n    map.setTerrain({ source: \"mapbox-dem\", exaggeration: 1.5 })\n    addMapillaryFeature(\n      map,\n      window.state.feature_collection,\n      \"object--support--utility-pole\"\n    )\n    addMapillaryFeature(\n      map,\n      window.state.feature_collection,\n      \"object--sign--store\"\n    )\n\n    updateMapWithRasters(map, window.state.rasters)\n  })\n  window.palette = buildColorPalette(state.unique_labels)\n\n  assignColorsToFeatures(state.feature_collection.features)\n\n  map.on(\"draw.create\", function (e) {\n    console.log(\"draw.create\")\n    e.features[0].type = \"Feature\"\n    e.features[0].properties = {\n      color: window.palette[window.state.selected_label],\n      description: window.state.selected_label,\n      type: \"click\",\n    }\n    window.draw.add(e.features[0])\n    window.state.feature_collection.features.push(e.features[0])\n    console.log(window.state.feature_collection.features)\n    window.state.updateViewportFromMap(map)\n    var vectorSourceIds = addGeoJSONLayers(\n      window.map,\n      window.state.unique_labels,\n      window.state.feature_collection\n    )\n    var rasterSourceIds = window.state.rasters.map(\n      (raster) => raster.png_filename\n    )\n    var sourceIds = [...rasterSourceIds, ...Array.from(vectorSourceIds)]\n\n    const sliderOverlayControl = new SliderOverlayControl(sourceIds, window.map)\n    window.map.addControl(sliderOverlayControl, \"top-left\")\n\n    updateBackendWithState()\n  })\n  map.on(\"draw.update\", function (e) {\n    console.log(\"draw.update\")\n    var features = [\n      ...window.draw.getAll().features,\n      ...window.state.feature_collection.features,\n    ]\n    // make them a set then array to remove duplicates\n    window.state.feature_collection.features = Array.from(new Set(features))\n    window.state.updateViewportFromMap(map)\n    updateBackendWithState()\n  })\n  map.addControl(\n    new mapboxgl.ScaleControl({ maxWidth: 80, unit: \"metric\" }),\n    \"bottom-right\"\n  )\n  return map\n}\n\nfunction onRender(event: Event): void {\n  const data = (event as CustomEvent<RenderData>).detail\n  CartographerState.initializeFromEvent(data)\n  window.state = CartographerState.getInstance()\n  window.palette = buildColorPalette(window.state.unique_labels)\n  if (!window.map_initialized) {\n    window.map = initializeMap(window.state)\n    window.map_initialized = true\n  }\n  if (\n    window.state.unique_labels.length > 0 &&\n    !window.draw_ctrl_visible &&\n    styleLoaded\n  ) {\n    window.draw = buildDrawPlugin()\n    window.draw_ctrl_visible = true\n  }\n\n  // check whether the list of raster png_filenames is the same as those in sources\n  let changed = false\n  for (let i = 0; i < window.state.rasters.length; i++) {\n    let raster = window.state.rasters[i]\n    if (!window.sources.has(raster.png_filename)) {\n      changed = true\n    }\n  }\n  if (styleLoaded && changed) {\n    updateMapWithRasters(window.map, window.state.rasters)\n  }\n\n  if (\n    styleLoaded &&\n    window.map_initialized &&\n    window.state.feature_collection.features.length > 0\n  ) {\n    var vectorSourceIds = addGeoJSONLayers(\n      window.map,\n      window.state.unique_labels,\n      window.state.feature_collection\n    )\n    var rasterSourceIds = window.state.rasters.map(\n      (raster) => raster.png_filename\n    )\n    var sourceIds = [...rasterSourceIds, ...Array.from(vectorSourceIds)]\n\n    const sliderOverlayControl = new SliderOverlayControl(sourceIds, window.map)\n    window.map.addControl(sliderOverlayControl, \"top-left\")\n  }\n}\n\n// Attach our `onRender` handler to Streamlit's render event.\nStreamlit.events.addEventListener(Streamlit.RENDER_EVENT, onRender)\n\n// Tell Streamlit we're ready to start receiving data. We won't get our\n// first RENDER_EVENT until we call this function.\nStreamlit.setComponentReady()\n\n// Finally, tell Streamlit to update our initial height. We omit the\n// `height` parameter here to have it default to our scrollHeight.\nStreamlit.setFrameHeight()\n"],"sourceRoot":""}