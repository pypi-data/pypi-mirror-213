#!python
from uun_iot.Gateway import Gateway
from uun_weatherstation.modules import init

import logging
import time
import argparse
import sys
import signal

__version__ = "0.6.2"
__package__ = "uun_weatherstation"
library = "uun_iot"

def main():
    argp = argparse.ArgumentParser(prog=__package__, description='Connect to weatherlink weatherstation and process informations and send to server.')
    argp.add_argument('-v', '--version', action='version', version='%(prog) ' + __version__)
    argp.add_argument('-l', '--log', metavar='loglevel', dest='loglevel', type=str, help='level of logging: [DEBUG, INFO, WARNING, ERROR, CRITICAL]', default='WARNING')
    args = argp.parse_args()
 
    ## = SETTING LOGGING = ##
    # set log level from option
    loglevel = args.loglevel
    llevel = getattr(logging, loglevel.upper(), None)
    if not isinstance(llevel, int):
        raise ValueError('Invalid log level: %s' % loglevel)

    # set formatting and levels for this package and library (uuniot)
    loggerw = logging.getLogger(__package__) # application specific logger
    loggerw.setLevel(llevel)
    loggeru = logging.getLogger(library) # library logger
    loggeru.setLevel(llevel)
    
    # console handler (output text to console), here can be added file handlers, server handlers, ...
    ch = logging.StreamHandler()
    ch.setLevel(llevel)
    # set log format
    formatter = logging.Formatter('%(name)s - %(levelname)s - %(message)s')
    # formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')

    ch.setFormatter(formatter)

    # asssign the same handler to loggers
    loggerw.addHandler(ch)
    loggeru.addHandler(ch)

    # start module system
    print("=== " + __package__ + " ===")
    with Gateway('config.json', init) as g:
        # Register a SIGTERM signal, as it is issued by systemd on stop/restart.
        #   Because by default, it does not run destructors.
        # Ctrl-C (SINGINT) correctly runs destructors, so no need to register.
        # SIGUSR1 is used internally by HealthCheck to restart the gateway
        signal.signal(signal.SIGTERM, g.signal_handler)
        signal.signal(signal.SIGINT, g.signal_handler)
        signal.signal(signal.SIGUSR1, g.signal_handler)

        g.stopev.wait()

if __name__ == '__main__':
    main()
