============================
Release notes for IRRd 4.2.2
============================

IRRd 4.2.2 was released on December 2nd, 2021, and fixes four issues that
occurred in 4.2.1:

* If users created multiple objects with the same RPSL primary key, in the
  same source, with different object classes, IRRD would only
  `import one of them and discarded the other`_. This could occur, for example,
  when a `mntner` and `as-set` had the same name. This issue was quite rare.
* When running on PyPy, IRRD had
  `infinite file descriptor growth`_ causing it to run out
  of file descriptors eventually regardless of configured limits.
* IRRD `was unable to run in the foreground with stdout logging`_.
* IRRD would `reject the autogenerated last-modified attribute`_ in submitted 
  objects, which was confusing to users.
  
.. _import one of them and discarded the other: https://github.com/irrdnet/irrd/issues/560
.. _infinite file descriptor growth: https://github.com/irrdnet/irrd/issues/578
.. _was unable to run in the foreground with stdout logging: https://github.com/irrdnet/irrd/issues/557
.. _reject the autogenerated last-modified attribute: https://github.com/irrdnet/irrd/issues/587

Steps required to upgrade
-------------------------
IRRD 4.2.2 contains new changes to the PostgreSQL database.
This means you must run the
:ref:`irrd_database_upgrade <deployment-database-upgrade>`
command as part of the update process.

Follow these steps to upgrade:

* Disable all cron and e-mail triggered tasks. There should be no calls
  to any IRRd scripts during the upgrade process.
* Upgrade your installed version of IRRD to 4.2.2.
* Run :ref:`irrd_database_upgrade <deployment-database-upgrade>`. This may take
  several minutes.
* Start IRRd and re-enable the cron / e-mail triggered tasks.

Between the time that the upgrade finishes and IRRD is restarted, mirroring
processes may fail. This will automatically recover after the restart.

The underlying reason is that if your database version is inconsistent with the
version of running IRRD code, inserting or updating RPSL objects will fail.
Therefore, user updates received over e-mail should be paused during this time.

As with all other database upgrades, you can also choose to entirely shut down
IRRD during the database upgrade.

Downgrading from 4.2.2 to 4.2.1
-------------------------------
If you are running IRRd 4.2.2, and would like to downgrade back to 4.2.1,
the database schema needs to be reverted. You can either restore an older
copy of your database, start with a fresh database, or use the database
migrations.

If you want to use the database migrations, run this command **before**
downgrading your local package installation to 4.2.1::

    irrd_database_downgrade --version 893d0d5363b3

If you would like to re-upgrade to 4.2.2 later on, you will need to run
the database migrations again, as listed in the upgrade steps.
